<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sierra Adventure</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        
        .game-container {
            width: 640px;
            height: 480px;
            position: relative;
            border: 2px solid #888;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .scene {
            width: 100%;
            height: 400px;
            background-color: #000;
            position: relative;
            overflow: hidden;
            image-rendering: pixelated;
        }
        
        .player {
            width: 32px;
            height: 64px;
            position: absolute;
            bottom: 30px;
            left: 50%;
            background-color: transparent; /* We'll draw the player with code */
            background-size: cover;
            z-index: 10;
            transform: translateX(-50%);
        }
        
        .control-panel {
            width: 100%;
            height: 80px;
            background-color: #222;
            border-top: 2px solid #444;
            display: flex;
            flex-direction: column;
        }
        
        .status-bar {
            height: 20px;
            background-color: #333;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
        }
        
        .score {
            margin-right: auto;
        }
        
        .input-area {
            display: flex;
            height: 60px;
            padding: 0 10px;
            align-items: center;
        }
        
        .command-input {
            flex-grow: 1;
            height: 30px;
            background-color: #111;
            border: 1px solid #555;
            color: #0f0;
            padding: 0 10px;
            font-family: 'Courier New', monospace;
        }
        
        .action-buttons {
            display: flex;
            background-color: #333;
            border-radius: 5px;
            padding: 5px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .action-button {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: #555;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .action-button:hover {
            background-color: #777;
        }
        
        .inventory {
            width: 640px;
            height: 100px;
            background-color: #222;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            padding: 5px;
            overflow-y: auto;
        }
        
        .inventory-item {
            width: 50px;
            height: 50px;
            background-color: #333;
            margin: 5px;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #222;
            border: 2px solid #fff;
            padding: 20px;
            min-width: 300px;
            z-index: 100;
            display: none;
        }
        
        .hotspot {
            position: absolute;
            background-color: rgba(255,255,255,0.1);
            cursor: pointer;
        }
        
        .room {
            width: 100%;
            height: 100%;
            position: absolute;
            background-size: 100% 100%;
        }
        
        .room-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Hint system styles */
        .game-hint {
            transition: opacity 0.5s;
        }
        
        /* Intro sequence styles */
        .intro-container {
            background-color: black;
            color: white;
            z-index: 1000;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes typewriter {
            from { width: 0 }
            to { width: 100% }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="scene">
            <canvas id="room-canvas" class="room-canvas" width="640" height="400"></canvas>
            <div class="player" id="player"></div>
            <!-- Hotspots will be added here dynamically -->
        </div>
        <div class="control-panel">
            <div class="status-bar">
                <span class="score">Score: 0 of 500</span>
                <span class="time" id="game-time"></span>
            </div>
            <div class="input-area">
                <input type="text" class="command-input" id="command-input" placeholder="Enter command...">
            </div>
        </div>
    </div>
    
    <div class="action-buttons">
        <button class="action-button" id="look-btn">Look</button>
        <button class="action-button" id="talk-btn">Talk</button>
        <button class="action-button" id="walk-btn">Walk</button>
        <button class="action-button" id="use-btn">Use</button>
        <button class="action-button" id="inventory-btn">Inventory</button>
    </div>
    
    <div class="inventory" id="inventory">
        <!-- Inventory items will be added here dynamically -->
    </div>
    
    <div class="message-box" id="message-box">
        <p id="message-text"></p>
        <button id="message-ok">OK</button>
    </div>

    <!-- Add the placeholder images script before the main game script -->
    <script src="placeholder-images.js"></script>
    
    <script>
        // Create a namespace for the game to avoid polluting global scope
        const SierraAdventure = {
            // Game state - moved from global to namespace
            gameState: {
                currentRoom: 'bar',
                inventory: [],
                score: 0,
                gameTime: 0,
                playerAction: 'walk', // walk, look, talk, use
                selectedItem: null,
                playerName: 'Larry',
                flags: {
                    talkedToBartender: false,
                    gotHotelKey: false,
                    solvedPuzzle: false
                }
            },
            
            // Rooms data - unchanged structure but moved into namespace
            rooms: {
                bar: {
                    background: 'bar-background.png',
                    description: "You're in a dimly lit bar called 'The Thirsty Snake'. The air is thick with smoke and the sounds of jazz music.",
                    hotspots: [
                        {
                            name: 'bartender',
                            x: 400, y: 150,
                            width: 60, height: 100,
                            description: "A gruff looking bartender wiping glasses clean.",
                            actions: {
                                look: "The bartender looks like he's seen it all. He's wearing a stained apron and has a thick mustache.",
                                talk: function() {
                                    if (!SierraAdventure.gameState.flags.talkedToBartender) {
                                        SierraAdventure.gameState.flags.talkedToBartender = true;
                                        SierraAdventure.addScore(5);
                                        return "\"What'll it be, stranger?\" the bartender asks. \"We've got the usual stuff. Say, you look like someone who might be interested in what's happening at the old hotel downtown. Some strange folks been going in and out of there lately.\"";
                                    } else {
                                        return "\"Already told you what I know, pal. Check out that hotel if you're curious.\"";
                                    }
                                },
                                use: "I don't think you should try to use the bartender."
                            }
                        },
                        {
                            name: 'door',
                            x: 50, y: 150,
                            width: 80, height: 150,
                            description: "A door leading outside.",
                            actions: {
                                look: "It's an old wooden door with peeling paint.",
                                use: "exit-to-street"
                            }
                        },
                        {
                            name: 'barstool',
                            x: 300, y: 250,
                            width: 50, height: 50,
                            description: "An empty barstool.",
                            actions: {
                                look: "A rickety wooden barstool with a worn leather seat.",
                                use: "You sit down on the barstool. The bartender glances your way expectantly."
                            }
                        },
                        {
                            name: 'mysterious-woman',
                            x: 200, y: 200,
                            width: 50, height: 100,
                            description: "A beautiful woman in a red dress sitting alone at a table.",
                            actions: {
                                look: "She's gorgeous! Long blonde hair, red dress, and legs that seem to go on forever.",
                                talk: "You approach with your best smile. \"Hello there, handsome,\" she says with a wink. \"If you're looking for excitement, I hear room 204 at the Starlight Hotel might interest you. But you'll need a key...\" She slides a small hotel key across the table.",
                                use: "You should probably talk to her first."
                            }
                        },
                        {
                            name: 'hotel-key',
                            x: 200, y: 230,
                            width: 15, height: 10,
                            description: "A small brass hotel key with '204' engraved on it.",
                            actions: {
                                look: "A small brass key with '204' engraved on it. Probably for the Starlight Hotel.",
                                use: "You should take it first.",
                                pickup: true
                            }
                        }
                    ],
                    exits: {
                        'street': { x: 50, y: 200 }
                    }
                },
                street: {
                    background: 'street-background.png',
                    description: "You're on a busy street with neon signs illuminating the night. The bar is behind you, and you can see a hotel down the street.",
                    hotspots: [
                        {
                            name: 'bar-entrance',
                            x: 400, y: 150,
                            width: 100, height: 200,
                            description: "The entrance to the bar.",
                            actions: {
                                look: "The bar's entrance has a flickering neon sign that reads 'The Thirsty Snake'.",
                                use: "exit-to-bar"
                            }
                        },
                        {
                            name: 'mysterious-person',
                            x: 150, y: 200,
                            width: 50, height: 100,
                            description: "A mysterious person standing in the shadows.",
                            actions: {
                                look: "You can't make out their face, but they seem to be watching you.",
                                talk: "\"Psst... looking for a good time? I might have information you need... for a price.\"",
                                use: "I don't think they would appreciate that."
                            }
                        },
                        {
                            name: 'newspaper',
                            x: 100, y: 350,
                            width: 30, height: 20,
                            description: "A crumpled newspaper on the ground.",
                            actions: {
                                look: "It's today's newspaper, but it's been stepped on and is partially unreadable.",
                                use: "You pick up the newspaper and find a circled classified ad for 'The Starlight Hotel - Under New Management'.",
                                pickup: true
                            }
                        },
                        {
                            name: 'hotel-entrance',
                            x: 50, y: 150,
                            width: 80, height: 150,
                            description: "The entrance to the Starlight Hotel.",
                            actions: {
                                look: "The hotel has a flickering neon sign. It looks a bit run down, but still operational.",
                                use: "exit-to-hotel-lobby"
                            }
                        }
                    ],
                    exits: {
                        'bar': { x: 400, y: 200 },
                        'hotel-lobby': { x: 50, y: 200 }
                    }
                },
                'hotel-lobby': {
                    background: 'hotel-lobby-background.png',
                    description: "You're in the lobby of the Starlight Hotel. It's seen better days, with worn carpets and dim lighting.",
                    hotspots: [
                        {
                            name: 'receptionist',
                            x: 300, y: 150,
                            width: 60, height: 100,
                            description: "A sleepy-looking receptionist behind the counter.",
                            actions: {
                                look: "The receptionist looks like he'd rather be anywhere else.",
                                talk: "\"Welcome to the Starlight Hotel, where dreams come true... or whatever,\" he says with zero enthusiasm. \"Rooms are $60 per night. ID required.\""
                            }
                        },
                        {
                            name: 'elevator',
                            x: 200, y: 150,
                            width: 50, height: 100,
                            description: "An old elevator with a worn button panel.",
                            actions: {
                                look: "The elevator looks operational, but just barely.",
                                use: "exit-to-hotel-hallway"
                            }
                        },
                        {
                            name: 'plant',
                            x: 100, y: 200,
                            width: 40, height: 80,
                            description: "A fake plastic plant covered in dust.",
                            actions: {
                                look: "It's a dusty fake plant. Looking closer, you notice something glinting in the pot.",
                                use: "You rummage through the plant's pot and find a quarter! Lucky you."
                            }
                        },
                        {
                            name: 'exit',
                            x: 450, y: 150,
                            width: 80, height: 150,
                            description: "The exit back to the street.",
                            actions: {
                                look: "The door leads back to the street.",
                                use: "exit-to-street"
                            }
                        }
                    ],
                    exits: {
                        'street': { x: 450, y: 200 },
                        'hotel-hallway': { x: 200, y: 200 }
                    }
                },
                'hotel-hallway': {
                    background: 'hotel-hallway-background.png',
                    description: "You're in a long, dimly lit hallway on the second floor of the hotel. There are several doors along both walls.",
                    hotspots: [
                        {
                            name: 'room-204',
                            x: 300, y: 150,
                            width: 60, height: 100,
                            description: "Room 204. There's something special about this room...",
                            actions: {
                                look: "The door to Room 204. You can hear faint music coming from inside.",
                                use: function() {
                                    if (SierraAdventure.hasItem('hotel-key')) {
                                        return "exit-to-secret-room";
                                    } else {
                                        return "The door is locked. You need a key to enter.";
                                    }
                                }
                            }
                        },
                        {
                            name: 'elevator',
                            x: 100, y: 150,
                            width: 50, height: 100,
                            description: "The elevator that leads back to the lobby.",
                            actions: {
                                look: "The same rickety elevator that brought you here.",
                                use: "exit-to-hotel-lobby"
                            }
                        },
                        {
                            name: 'window',
                            x: 450, y: 100,
                            width: 80, height: 120,
                            description: "A window at the end of the hallway.",
                            actions: {
                                look: "Looking out the window, you can see the street below. The city never sleeps.",
                                use: "You try to open the window, but it's painted shut."
                            }
                        }
                    ],
                    exits: {
                        'hotel-lobby': { x: 100, y: 200 },
                        'secret-room': { x: 300, y: 200 }
                    }
                },
                'secret-room': {
                    background: 'secret-room-background.png',
                    description: "You've entered Room 204. To your surprise, it's actually a secret casino operation!",
                    hotspots: [
                        {
                            name: 'dealer',
                            x: 300, y: 150,
                            width: 60, height: 100,
                            description: "A card dealer in a fancy suit.",
                            actions: {
                                look: "The dealer has slick hair and an even slicker smile.",
                                talk: "\"Welcome to our exclusive establishment,\" the dealer says. \"Care to try your luck? The password for tonight is 'Sierra'.\""
                            }
                        },
                        {
                            name: 'card-table',
                            x: 200, y: 250,
                            width: 100, height: 50,
                            description: "A green felt card table with poker chips stacked neatly.",
                            actions: {
                                look: "A professional card table. High stakes games are played here.",
                                use: "You don't have enough money to join the game right now."
                            }
                        },
                        {
                            name: 'mysterious-package',
                            x: 400, y: 300,
                            width: 50, height: 30,
                            description: "A mysterious package left unattended.",
                            actions: {
                                look: "A small brown package wrapped in paper. No one seems to be watching it.",
                                use: "You quickly grab the package when no one is looking!",
                                pickup: true
                            }
                        },
                        {
                            name: 'exit',
                            x: 100, y: 150,
                            width: 50, height: 100,
                            description: "The exit back to the hallway.",
                            actions: {
                                look: "The door leading back to the hotel hallway.",
                                use: "exit-to-hotel-hallway"
                            }
                        }
                    ],
                    exits: {
                        'hotel-hallway': { x: 100, y: 200 }
                    }
                }
            },

            // Cached DOM elements for better performance
            domElements: {},

            // Initialize the game
            init: function() {
                // Cache DOM elements for faster access
                this.cacheDOMElements();
                
                // Initialize network monitoring to catch PNG load attempts
                this.monitorNetworkForPngRequests();
                
                // Generate player sprite directly in the player div
                this.generatePlayerSprite();
                
                this.updateRoom();
                this.timers = {
                    gameTime: setInterval(this.updateGameTime.bind(this), 1000)
                };
                
                // Event listeners with proper binding to avoid memory leaks
                this.setupEventListeners();
                
                // Start with walk as the default action
                this.setPlayerAction('walk');
                
                // Initialize the hint system
                this.initHintSystem();
                
                // Enable debug mode by default to make objects visible
                window.debugMode = true;
                
                // Show welcome message
                this.showMessage(`Welcome to "Hotel of Desire: A Sierra-style Adventure"! You are ${this.gameState.playerName}, a lovable loser on a quest for love and excitement in the big city. Type 'help' for commands.`);
            },
            
            cacheDOMElements: function() {
                // Cache all DOM elements used frequently for better performance
                this.domElements = {
                    scene: document.querySelector('.scene'),
                    player: document.getElementById('player'),
                    roomCanvas: document.getElementById('room-canvas'),
                    inventory: document.getElementById('inventory'),
                    messageBox: document.getElementById('message-box'),
                    messageText: document.getElementById('message-text'),
                    messageOk: document.getElementById('message-ok'),
                    scoreElement: document.querySelector('.score'),
                    timeElement: document.getElementById('game-time'),
                    commandInput: document.getElementById('command-input'),
                    actionButtons: {
                        look: document.getElementById('look-btn'),
                        talk: document.getElementById('talk-btn'),
                        walk: document.getElementById('walk-btn'),
                        use: document.getElementById('use-btn'),
                        inventory: document.getElementById('inventory-btn')
                    }
                };
            },
            
            setupEventListeners: function() {
                // Event listeners with proper binding to maintain 'this' context
                this.domElements.commandInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.processCommand(e.target.value);
                        e.target.value = '';
                    }
                });
                
                // Action buttons
                this.domElements.actionButtons.look.addEventListener('click', () => this.setPlayerAction('look'));
                this.domElements.actionButtons.talk.addEventListener('click', () => this.setPlayerAction('talk'));
                this.domElements.actionButtons.walk.addEventListener('click', () => this.setPlayerAction('walk'));
                this.domElements.actionButtons.use.addEventListener('click', () => this.setPlayerAction('use'));
                this.domElements.actionButtons.inventory.addEventListener('click', () => this.toggleInventory());
                
                this.domElements.messageOk.addEventListener('click', () => this.closeMessage());
                
                // Scene click with bound this context
                this.domElements.scene.addEventListener('click', (e) => this.handleSceneClick(e));
                
                // Keyboard controls with bound this context
                document.addEventListener('keydown', (e) => this.handleKeyboardMovement(e));
            },
            
            // Function to generate player sprite - optimized with typescript integration
            generatePlayerSprite: function() {
                const playerDiv = this.domElements.player;
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 64;
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                
                const ctx = canvas.getContext('2d');
                
                // Use the TypeScript PixelSprite if available
                if (window.gameSprites && window.gameSprites.playerCharacter) {
                    window.gameSprites.playerCharacter.render(ctx, 0, 0, 8); // Scale up by 8
                } else {
                    // Fallback sprite if TypeScript-generated one isn't available
                    ctx.fillStyle = '#3050FF'; // Blue
                    ctx.fillRect(8, 16, 16, 32); // Body
                    ctx.fillStyle = '#FFC8A2'; // Skin tone
                    ctx.fillRect(8, 0, 16, 16); // Head
                }
                
                playerDiv.appendChild(canvas);
            },

            // Optimized room rendering with support for TypeScript sprites
            updateRoom: function() {
                const room = this.rooms[this.gameState.currentRoom];
                if (!room) {
                    console.error(`Room "${this.gameState.currentRoom}" not found!`);
                    return;
                }
                
                const canvas = this.domElements.roomCanvas;
                const ctx = canvas.getContext('2d');
                
                // Clear the canvas with a single operation
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Use a single array and find operation to get background image
                const backgroundVariants = [
                    room.background,                // Original (with .png)
                    room.background.replace('.png', ''),  // Without extension
                    room.background.toLowerCase(),        // Lowercase version
                    room.background.toLowerCase().replace('.png', ''), // Lowercase without extension
                    this.gameState.currentRoom + 'Scene' // Scene-named variant
                ];
                
                // Find the first available variant
                let backgroundImage = null;
                for (const variant of backgroundVariants) {
                    if (window.gameImages && window.gameImages[variant]) {
                        backgroundImage = window.gameImages[variant];
                        break;
                    }
                }
                
                if (backgroundImage) {
                    // Draw the background image
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Draw room-specific elements once background is loaded
                        this.drawRoomElements(ctx, room);
                    };
                    img.src = backgroundImage;
                } else {
                    // Fallback rendering
                    ctx.fillStyle = '#222222';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw fallback text
                    ctx.fillStyle = '#FF0000';
                    ctx.font = '20px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Missing background: ${room.background}`, canvas.width/2, canvas.height/2);
                    
                    // Draw room elements even without background
                    this.drawRoomElements(ctx, room);
                }
                
                // Clear and recreate hotspots in a single operation for better performance
                const existingHotspots = document.querySelectorAll('.hotspot');
                existingHotspots.forEach(h => h.remove());
                
                // Create document fragment for better performance when adding multiple elements
                const fragment = document.createDocumentFragment();
                
                // Add new hotspots
                room.hotspots.forEach(hotspot => {
                    const hotspotElement = document.createElement('div');
                    hotspotElement.className = 'hotspot';
                    hotspotElement.dataset.name = hotspot.name;
                    hotspotElement.style.left = `${hotspot.x}px`;
                    hotspotElement.style.top = `${hotspot.y}px`;
                    hotspotElement.style.width = `${hotspot.width}px`;
                    hotspotElement.style.height = `${hotspot.height}px`;
                    
                    fragment.appendChild(hotspotElement);
                });
                
                // Add all hotspots at once
                this.domElements.scene.appendChild(fragment);
                
                // Show room description
                this.showMessage(room.description);
            },
            
            // Optimized room element drawing with batched rendering where possible
            drawRoomElements: function(ctx, room) {
                // Save canvas state once for better performance
                ctx.save();
                
                // Draw hotspots with actual character/object sprites
                room.hotspots.forEach(hotspot => {
                    // Try to get a sprite for this hotspot
                    const spriteName = hotspot.name;
                    if (window.gameSprites && window.gameSprites[spriteName]) {
                        // Draw the actual sprite
                        const sprite = window.gameSprites[spriteName];
                        sprite.render(ctx, hotspot.x, hotspot.y, 4); // Scale factor of 4
                    } else if (window.debugMode) {
                        // Draw debug visualization
                        ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(hotspot.x, hotspot.y, hotspot.width, hotspot.height);
                        
                        // Draw name of the hotspot
                        ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
                        ctx.font = '10px monospace';
                        ctx.fillText(hotspot.name, hotspot.x, hotspot.y - 2);
                    }
                });
                
                // Draw exit indicators to help navigation
                if (room.exits) {
                    // Batch similar drawing operations
                    ctx.fillStyle = 'rgba(100, 255, 100, 0.2)';
                    ctx.beginPath();
                    
                    Object.entries(room.exits).forEach(([exitName, exitPos]) => {
                        // Add to the current path instead of starting a new one
                        ctx.moveTo(exitPos.x, exitPos.y);
                        ctx.arc(exitPos.x, exitPos.y, 15, 0, Math.PI * 2);
                    });
                    
                    // Fill all exit indicators in one operation
                    ctx.fill();
                    
                    // Now draw all labels
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.font = '12px monospace';
                    ctx.textAlign = 'center';
                    
                    Object.entries(room.exits).forEach(([exitName, exitPos]) => {
                        ctx.fillText(`To: ${exitName}`, exitPos.x, exitPos.y + 30);
                    });
                }
                
                // Restore canvas state
                ctx.restore();
            },
            
            // Remaining methods follow the same pattern - proper 'this' binding and organization
            // ...existing methods with 'this' context fixed...

            // Event handlers with proper this binding
            handleSceneClick: function(e) {
                // Get click position relative to scene
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if we clicked on a hotspot
                const clickedHotspot = this.findHotspotAt(x, y);
                
                if (clickedHotspot) {
                    this.handleHotspotInteraction(clickedHotspot);
                } else if (this.gameState.playerAction === 'walk') {
                    this.movePlayer(x, y);
                }
            },
            
            // Add remaining methods...
            // Most existing method implementations remain the same but with 'this' references fixed
        };

        // Start the game when page loads
        window.addEventListener('load', () => SierraAdventure.init());
    </script>
</body>
</html>